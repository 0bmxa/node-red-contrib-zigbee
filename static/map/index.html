<!DOCTYPE html>
<head><script type="text/javascript" src="../vis/vis.min.js"></script>
<link href="../vis/vis.min.css" type="text/css">
<style>
    html, body {
        height: 100%;
        font-family: arial;
        margin: 0;
        padding: 0;
    }
    h4 {
        margin: 6px;
    }
    #map {
        height: calc(100% - 30px);
    }
    #loader {
        position: absolute;
        top: 50px;
        left: calc(50% - 64px);
    }
</style>
</head><body>
<h4>ZigBee Network Map</h4>
<img src="loader.gif" id="loader">
<div id="map"></div>


<script type="text/javascript">

    const container = document.querySelector('#map');

    let devices;
    let routes = [];
    let knownRoutes = new Set();

    fetch('../devices' + window.location.search)
        .then(response => {
            return response.json();
        })
        .then(data => {
            devices = data;
            return getRtg();
        })
        .catch(err => {
            container.innerHTML = err.message;
        })
        .finally(() => {
            document.querySelector('#loader').remove();
        });

    function getRtg() {
        return fetch('../rtgScan' + window.location.search)
            .then(response => {
                return response.json();
            })
            .then(data => {
                console.log(data);
                Object.keys(data).forEach(src => {
                    if (data[src].routingtablelist) {
                        data[src].routingtablelist.forEach(route => {
                            const id = src + '|' + route.nextHopNwkAddr;
                            if (!knownRoutes.has(id)) {
                                knownRoutes.add(id);
                                routes.push({
                                    sourceIeeeAddr: src,
                                    targetIeeeAddr: getIeeeAddr(route.nextHopNwkAddr),
                                    routeStatus: route.routeStatus
                                });
                            }
                        });
                    }
                });

                createGraph();

            });
    }


    function getIeeeAddr(nwkAddr) {
        let ieeeAddr;
        const devs = Object.keys(devices).filter(ieeeAddr => devices[ieeeAddr].nwkAddr === nwkAddr);
        if (devs.length === 1) {
            return devs[0];
        }
    }


    function createGraph() {
        let coordAddr;

        const routesData = routes.map(route => {
            return {
                from: route.sourceIeeeAddr,
                to: route.targetIeeeAddr,
                label: String(route.lqi), //rssi(pair.lqi),
                arrows: 'to',
                dashes: route.routeStatus === 0,
                color: {inherit: 'to'},
                font: {
                    color: 'rgba(0,0,0,0)'
                },
                chosen: {
                    label: values => {
                        values.color = {inherit: 'to'};
                        values.mod = 'bold';
                    }
                }
            };
        });

        console.log(routesData);

        const data = {
            nodes: new vis.DataSet(Object.keys(devices).map(ieeeAddr => {
                const dev = devices[ieeeAddr];
                const isCoord = dev.type === 'Coordinator';
                isCoord && (coordAddr = ieeeAddr);
                const isRouter = dev.type === 'Router';
                const isBattery = dev.powerSource === 'Battery';
                const id = ieeeAddr;
                const status = isBattery
                    ? (dev.overdue ? 'overdue' : '')
                    : (dev.status === 'offline' ? 'offline' : '');
                const isOffline = Boolean(status);
                const children = routes.filter(pair => pair.targetIeeeAddr === dev.ieeeAddr).length;
                const label = [
                    dev.name,
                    dev.type,
                    dev.ieeeAddr,
                    dev.manufName,
                    dev.modelId,
                    dev.powerSource,
                    !isCoord && status,
                    children ? 'Children: ' + children + (isCoord ? (' (' + Object.keys(devices).length + ')') : '') : ''
                ].filter(v => v).join('\n');

                return {
                    id,
                    label,
                    shape: children ? 'circle' : 'box',
                    shapeProperties: {
                        borderDashes: isOffline
                    },
                    color: {
                        background: isCoord ? '#B2DC96' : isBattery ? '#E5F2FF' : '#D2E5FF',
                        border: isCoord ? '#028C76' :  isBattery ? '#3386E9' : '#2B7CE9',
                        highlight: {
                            background: isCoord ? '#B2DC96' :  isBattery ? '#D2E5FF' : '#D2E5FF',
                            border: isCoord ? '#028C76' :  isBattery ? '#2B7CE9' : '#2B7CE9'
                        }
                    },
                    //mass: isCoord ? 1.0 : (isRouter ? 1.02 : (isOffline ? 1.035 : 1.025))


                }
            })),

            edges: new vis.DataSet(routesData)
        };

        const options = {
            layout: {
                //hierarchical: true
            },
            physics: {
                stabilization: true,
                solver: 'forceAtlas2Based',
                forceAtlas2Based: {
                    avoidOverlap: 0.00005
                },
                barnesHut: {
                    gravitationalConstant: -2000,
                    centralGravity: 0.37,
                    springLength: 89,
                    springConstant: 0.02,
                    damping: 0.09,
                    avoidOverlap: 0.25
                }
            }
        };

        const network = new vis.Network(container, data, options);
    }


    /*
        lqi => rssi
        https://e2e.ti.com/support/wireless-connectivity/zigbee-and-thread/f/158/t/555076?How-to-get-rssi-value-from-Z-Stack-Linux-Gateway-
        RSSI = MIN_ED+LinkQuality*( MAX_ED-MIN_ED)/255
        Default values for MIN_ED and MAX_ED are -87 and 10 respectively.
     */
    function rssi(lqi) {
        return lqi > 0 ? String(Math.round(-87 + lqi * 97 / 255)) : '';
    }
</script>
</body>