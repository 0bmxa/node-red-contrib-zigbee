<!DOCTYPE html>
<head><script type="text/javascript" src="../vis/vis.min.js"></script>
<link href="../vis/vis.min.css" type="text/css">
<style>
    html, body {
        height: 100%;
        font-family: arial;
        margin: 0;
        padding: 0;
    }
    h4 {
        margin: 6px;
    }
    #map {
        height: calc(100% - 30px);
    }
    #loader {
        position: absolute;
        top: 50px;
        left: calc(50% - 64px);
    }
</style>
</head><body>
<h4>ZigBee Network Map</h4>
<div id="loader"><img src="loader.gif" id="loader"><br><span id="status"></span></div>
<div id="map"></div>


<script type="text/javascript">

    const container = document.querySelector('#map');

    let devices;
    let routes = [];
    let routesMap = {}

    fetch('../devices' + window.location.search)
        .then(response => {
            return response.json();
        })
        .then(data => {
            devices = data;
            return getRtg();
        })
        .then(getLqi)
        .catch(err => {
            container.innerHTML = err.message;
        })
        .finally(() => {
            document.querySelector('#loader').remove();
        });

    function getRtg() {
        document.querySelector('#status').innerHTML = 'rtgScan...';
        return fetch('../rtgScan' + window.location.search)
            .then(response => {
                return response.json();
            })
            .then(data => {
                console.log('rtgScan', data);
                Object.keys(data).forEach(src => {
                    if (data[src].routingtablelist) {
                        data[src].routingtablelist.forEach(route => {
                            const id = src + '|' + route.nextHopNwkAddr;
                            if (!routesMap[id]) {
                                routesMap[id] = {
                                    sourceIeeeAddr: src,
                                    targetIeeeAddr: getIeeeAddr(route.nextHopNwkAddr == 65534 ? route.destNwkAddr : route.nextHopNwkAddr),
                                    routeStatus: route.routeStatus,
                                    count: 1
                                };
                            } else {
                                routesMap[id].count += 1;
                                routesMap[id].routeStatus |= route.routeStatus
                            }

                        });
                    }
                });



            })

    }

    function getLqi() {
        document.querySelector('#status').innerHTML = 'lqiScan...';
        return fetch('../lqiScan' + window.location.search)
            .then(response => {
                return response.json();
            })
            .then(data => {
                console.log('lqiScan', data);
                Object.keys(data).forEach(sourceIeeeAddr => {
                    data[sourceIeeeAddr].neighborlqilist.forEach(neighbour => {
                        const id = sourceIeeeAddr + '|' + neighbour.nwkAddr;
                        if (!routesMap[id]) {
                            routesMap[id] = {
                                sourceIeeeAddr,
                                targetIeeeAddr: neighbour.extAddr,
                                routeStatus: 0,
                                relationship: neighbour.relationship,
                                depth: neighbour.depth,
                                lqi: neighbour.lqi,
                                count: 1
                            };
                        } else {
                            routesMap[id].count += 1;
                            routesMap[id].lqi = neighbour.lqi;
                            routesMap[id].depth = neighbour.depth;
                            routesMap[id].relationship = neighbour.relationship;
                        }
                    });
                });

                console.log('routesMap', routesMap);
                Object.keys(routesMap).forEach(id => {
                    routes.push(routesMap[id]);
                });
                createGraph();
            });
    }

    function getIeeeAddr(nwkAddr) {
        const devs = Object.keys(devices).filter(ieeeAddr => devices[ieeeAddr].nwkAddr === nwkAddr);
        if (devs.length === 1) {
            return devs[0];
        }
    }


    function createGraph() {
        let coordAddr;
        console.log('routes', routes);
        const routesData = routes.map(route => {
            return {
                to: route.targetIeeeAddr,
                from: route.sourceIeeeAddr,
                label: rssi(route.lqi),
                arrows: 'from',
                dashes: typeof route.lqi === 'undefined',
                color: {inherit: 'to'},
                font: {
                    color: 'rgba(0,0,0,0)'
                },
                chosen: {
                    label: values => {
                        values.color = {inherit: 'to'};
                        values.mod = 'bold';
                    }
                }
            };
        });

        console.log(routesData);

        const data = {
            nodes: new vis.DataSet(Object.keys(devices).map(ieeeAddr => {
                const dev = devices[ieeeAddr];
                const isCoord = dev.type === 'Coordinator';
                isCoord && (coordAddr = ieeeAddr);
                const isRouter = dev.type === 'Router';
                const isBattery = dev.powerSource === 'Battery';
                const id = ieeeAddr;
                const status = isBattery
                    ? (dev.overdue ? 'overdue' : '')
                    : (dev.status === 'offline' ? 'offline' : '');
                const isOffline = Boolean(status);
                const children = routes.filter(pair => pair.sourceIeeeAddr === dev.ieeeAddr).length;
                const label = [
                    dev.name,
                    dev.type,
                    dev.ieeeAddr,
                    dev.manufName,
                    dev.modelId,
                    dev.powerSource,
                    !isCoord && status,
                    children ? 'Children: ' + children + (isCoord ? (' (' + Object.keys(devices).length + ')') : '') : ''
                ].filter(v => v).join('\n');

                return {
                    id,
                    label,
                    shape: children ? 'circle' : 'box',
                    shapeProperties: {
                        borderDashes: isOffline
                    },
                    color: {
                        background: isCoord ? '#B2DC96' : isBattery ? '#E5F2FF' : '#D2E5FF',
                        border: isCoord ? '#028C76' :  isBattery ? '#3386E9' : '#2B7CE9',
                        highlight: {
                            background: isCoord ? '#B2DC96' :  isBattery ? '#D2E5FF' : '#D2E5FF',
                            border: isCoord ? '#028C76' :  isBattery ? '#2B7CE9' : '#2B7CE9'
                        }
                    },
                    //mass: isCoord ? 1.0 : (isRouter ? 1.02 : (isOffline ? 1.035 : 1.025))


                }
            })),

            edges: new vis.DataSet(routesData)
        };

        const options = {
            layout: {
                //hierarchical: true
            },
            physics: {
                stabilization: true,
                solver: 'forceAtlas2Based',
                forceAtlas2Based: {
                    avoidOverlap: 0.00005
                },
                barnesHut: {
                    gravitationalConstant: -2000,
                    centralGravity: 0.37,
                    springLength: 89,
                    springConstant: 0.02,
                    damping: 0.09,
                    avoidOverlap: 0.25
                }
            }
        };

        const network = new vis.Network(container, data, options);
    }


    /*
        lqi => rssi
        https://e2e.ti.com/support/wireless-connectivity/zigbee-and-thread/f/158/t/555076?How-to-get-rssi-value-from-Z-Stack-Linux-Gateway-
        RSSI = MIN_ED+LinkQuality*( MAX_ED-MIN_ED)/255
        Default values for MIN_ED and MAX_ED are -87 and 10 respectively.
     */
    function rssi(lqi) {
        return lqi ? (String(Math.round(-87 + lqi * 97 / 255)) + ' dBm') : '';
    }
</script>
</body>