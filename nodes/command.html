<script type="text/javascript">
    RED.nodes.registerType('zigbee-command', {

        category: 'zigbee',
        defaults: {
            shepherd: {value: '', type: 'zigbee-shepherd', required: true},
            name: {value: 'command'},
            cmdType: {value: ''},
            ieeeAddr: {value: ''},
            ep: {value: ''},
            destination: {value: 'endpoint'},
            dstIeeeAddr: {value: ''},
            dstEp: {value: ''},
            dstGroup: {value: ''},
            cid: {value: ''},
            cmd: {value: ''},
            data: {value: ''},
            dataType: {value: 'str'},
            zclData: {value: '{}'},
            attrId: {value: 0},
            attrIdType: {value: 'num'},
            minInt: {value: 10},
            maxInt: {value: 1000},
            repChange: {value: 1},
            repChangeType: {value: 'num'},
            manufSpec: {value: 0},
            disableDefaultRsp: {value: 0}
        },
        inputs: 1,
        outputs: 1,
        icon: 'bee.png',
        color: '#E2D96E',
        paletteLabel: 'command',
        align: 'left',
        label() {
            return this.name || 'command';
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare() {
            $('#response').html('');

            const clusters = {
                genBasic: 0,
                genPowerCfg: 1,
                genDeviceTempCfg: 2,
                genIdentify: 3,
                genGroups: 4,
                genScenes: 5,
                genOnOff: 6,
                genOnOffSwitchCfg: 7,
                genLevelCtrl: 8,
                genAlarms: 9,
                genTime: 10,
                genRssiLocation: 11,
                genAnalogInput: 12,
                genAnalogOutput: 13,
                genAnalogValue: 14,
                genBinaryInput: 15,
                genBinaryOutput: 16,
                genBinaryValue: 17,
                genMultistateInput: 18,
                genMultistateOutput: 19,
                genMultistateValue: 20,
                genCommissioning: 21,
                genPartition: 22,
                genOta: 25,
                genPowerProfile: 26,
                genApplianceCtrl: 27,
                genPollCtrl: 32,
                genGreenPowerProxy: 33,
                mobileDeviceCfg: 34,
                neighborCleaning: 35,
                nearestGateway: 36,
                closuresShadeCfg: 256,
                closuresDoorLock: 257,
                closuresWindowCovering: 258,
                hvacPumpCfgCtrl: 512,
                hvacThermostat: 513,
                hvacFanCtrl: 514,
                hvacDehumidificationCtrl: 515,
                hvacUserInterfaceCfg: 516,
                lightingColorCtrl: 768,
                lightingBallastCfg: 769,
                msIlluminanceMeasurement: 1024,
                msIlluminanceLevelSensing: 1025,
                msTemperatureMeasurement: 1026,
                msPressureMeasurement: 1027,
                msFlowMeasurement: 1028,
                msRelativeHumidity: 1029,
                msOccupancySensing: 1030,
                ssIasZone: 1280,
                ssIasAce: 1281,
                ssIasWd: 1282,
                piGenericTunnel: 1536,
                piBacnetProtocolTunnel: 1537,
                piAnalogInputReg: 1538,
                piAnalogInputExt: 1539,
                piAnalogOutputReg: 1540,
                piAnalogOutputExt: 1541,
                piAnalogValueReg: 1542,
                piAnalogValueExt: 1543,
                piBinaryInputReg: 1544,
                piBinaryInputExt: 1545,
                piBinaryOutputReg: 1546,
                piBinaryOutputExt: 1547,
                piBinaryValueReg: 1548,
                piBinaryValueExt: 1549,
                piMultistateInputReg: 1550,
                piMultistateInputExt: 1551,
                piMultistateOutputReg: 1552,
                piMultistateOutputExt: 1553,
                piMultistateValueReg: 1554,
                piMultistateValueExt: 1555,
                pi11073ProtocolTunnel: 1556,
                piIso7818ProtocolTunnel: 1557,
                piRetailTunnel: 1559,
                sePrice: 1792,
                seDrlc: 1793,
                seMetering: 1794,
                seMessaging: 1795,
                seTunneling: 1796,
                sePrepayment: 1797,
                seEnergyMgmt: 1798,
                seCalendar: 1799,
                seDeviceMgmt: 1800,
                seEvents: 1801,
                seMduPairing: 1802,
                seKeyEstablishment: 2048,
                telecommunicationsInformation: 2304,
                telecommunicationsVoiceOverZigbee: 2308,
                telecommunicationsChatting: 2309,
                haApplianceIdentification: 2816,
                haMeterIdentification: 2817,
                haApplianceEventsAlerts: 2818,
                haApplianceStatistics: 2819,
                haElectricalMeasurement: 2820,
                haDiagnostic: 2821,
                lightLink: 4096,
                manuSpecificCluster: 65535
            };

            $('#node-input-data').typedInput({
                default: 'num',
                types: ['str', 'num'],
                typeField: '#node-input-dataType'
            });
            $('#node-input-attrId').typedInput({
                default: 'num',
                types: ['str', 'num'],
                typeField: '#node-input-AttrIdType'
            });
            $('#node-input-zclData').typedInput({
                default: 'json',
                types: ['json']
            });
            $('#node-input-repChange').typedInput({
                default: 'num',
                types: ['num', {value: 'none', label: '-', hasValue: false}],
                typeField: '#node-input-repChangeType'
            });
            $('#node-input-cid').autocomplete({
                source: Object.keys(clusters),
                delay: 0,
                minLength: 0
            });

            let epCompl = [];
            let dstEpCompl = [];

            $('#node-input-ep').autocomplete({
                source: epCompl,
                delay: 0,
                minLength: 0
            });

            $('#node-input-ep').on('focus', () => {
                if (epCompl.length > 0) {
                    $('#node-input-ep').autocomplete('search');
                }
            });

            $('#node-input-dstEp').autocomplete({
                source: dstEpCompl,
                delay: 0,
                minLength: 0
            });

            $('#node-input-dstEp').on('focus', () => {
                if (dstEpCompl.length > 0) {
                    $('#node-input-dstEp').autocomplete('search');
                }
            });

            const id = $('#node-input-shepherd').val();

            $.getJSON('zigbee-shepherd/devices?id=' + id, devices => {
                const compl = [];
                Object.keys(devices).forEach(ieeeAddr => {
                    compl.push(ieeeAddr + ' ' + devices[ieeeAddr].name);
                });
                $('#node-input-ieeeAddr').autocomplete({
                    source: compl,
                    delay: 0,
                    minLength: 0,
                    close: () => {
                        const ieeeAddr = $('#node-input-ieeeAddr').val().split(' ')[0];
                        // $('#node-input-ieeeAddr').val(ieeeAddr);
                        epCompl = devices[ieeeAddr].epList.map(e => String(e));
                        $('#node-input-ep').autocomplete('option', 'source', epCompl);
                    }
                });
                $('#node-input-ieeeAddr').on('focus', () => {
                    $('#node-input-ieeeAddr').autocomplete('search');
                });
                $('#node-input-dstIeeeAddr').autocomplete({
                    source: compl,
                    delay: 0,
                    minLength: 0,
                    close: () => {
                        const ieeeAddr = $('#node-input-dstIeeeAddr').val().split(' ')[0];
                        // $('#node-input-dstIeeeAddr').val(ieeeAddr);
                        dstEpCompl = devices[ieeeAddr].epList.map(e => String(e));
                        $('#node-input-dstEp').autocomplete('option', 'source', dstEpCompl);
                    }
                });
                $('#node-input-dstIeeeAddr').on('focus', () => {
                    $('#node-input-dstIeeeAddr').autocomplete('search');
                });
            });

            $('#node-input-cmdType').change(function () {
                const cmdType = $(this).val();
                $('.cmd-type').hide();
                $('.cmd-type.' + cmdType).show();
                $('#node-input-destination').trigger('change');
            });
            $('#node-input-cmdType').trigger('change');

            $('#node-input-destination').change(function () {
                switch (($('#node-input-cmdType').val() || '').endsWith('bind') && $(this).val()) {
                    case 'group':
                        $('.bind-endpoint').hide();
                        $('.bind-group').show();
                        break;
                    case 'endpoint':
                        $('.bind-group').hide();
                        $('.bind-endpoint').show();
                        break;
                    default:
                        $('.bind-group').hide();
                        $('.bind-endpoint').hide();
                }
            });
            $('#node-input-destination').trigger('change');

            $('#execute').click(() => {
                let zclData;

                try {
                    zclData = JSON.parse($('#node-input-zclData'));
                } catch (err) {
                    zclData = {};
                }

                const cmdType = $('#node-input-cmdType').val();
                const ieeeAddr = ($('#node-input-ieeeAddr').val() || '').split(' ')[0];
                const ep = Number($('#node-input-ep').val());
                const destination = $('#node-input-destination').val();
                const dstIeeeAddr = ($('#node-input-dstIeeeAddr').val() || '').split(' ')[0];
                const dstEp = Number($('#node-input-dstEp').val());
                const dstGroup = Number($('#node-input-dstGroup').val());
                const cid = $('#node-input-cid').val();
                const cmd = $('#node-input-cmd').val();
                const data = $('#node-input-dataType').val() === 'num' ? Number($('#node-input-data').val()) : $('#node-input-data').val();
                const attrId = $('#node-input-attrIdType').val() === 'num' ? Number($('#node-input-attrId').val()) : $('#node-input-attrId').val();
                const minInt = Number($('#node-input-minInt').val());
                const maxInt = Number($('#node-input-maxInt').val());
                const repChange = Number($('#node-input-repChange').val());
                const manufSpec = Number($('#node-input-manufSpec').val());
                const disableDefaultRsp = Number($('#node-input-disableDefaultRsp').val());

                let obj;

                switch (cmdType) {
                    case 'functional':
                    case 'foundation':
                        obj = {
                            cmdType,
                            ieeeAddr,
                            ep,
                            cid,
                            cmd,
                            zclData,
                            cfg: {
                                manufSpec,
                                disableDefaultRsp
                            }
                        };
                        break;
                    case 'write':
                        obj = {
                            cmdType,
                            ieeeAddr,
                            ep,
                            cid,
                            attrId,
                            data
                        };
                        break;
                    case 'read':
                        obj = {
                            cmdType,
                            ieeeAddr,
                            ep,
                            cid,
                            attrId
                        };
                        break;
                    case 'bind':
                    case 'unbind':
                        obj = {
                            cmdType,
                            ieeeAddr,
                            ep,
                            cid,
                            destination,
                            dstIeeeAddr,
                            dstEp,
                            dstGroup
                        };
                        break;
                    case 'report':
                        obj = {
                            cmdType,
                            ieeeAddr,
                            ep,
                            cid,
                            attrId,
                            minInt,
                            maxInt
                        };
                        if (repChange) {
                            obj.repChange = repChange;
                        }

                        break;
                    default:
                        this.error('unknown command ' + cmdType);
                }

                const id = $('#node-input-shepherd').val();
                $('#response').html('...');
                $.post('zigbee-shepherd/cmd?id=' + id, {cmd: JSON.stringify(obj)}, data => {
                    $('#response').html(JSON.stringify(data));
                }, 'json');
            });
        },
        oneditsave() {
            if (this.dataType === 'num') {
                this.data = Number(this.data);
            }

            if (this.attrIdType === 'num') {
                this.attrId = Number(this.attrId);
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="zigbee-command">
    <div class="form-row">
        <label for="node-input-shepherd"><i class="icon-global"></i> shepherd</label>
        <input type="text" id="node-input-shepherd">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-global"></i> name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-cmdType"><i class="icon-pencil"></i> cmdType</label>
        <select id="node-input-cmdType">
            <option>foundation</option>
            <option>functional</option>
            <option>read</option>
            <option>write</option>
            <option>bind</option>
            <option>unbind</option>
            <option>report</option>
            <!--<option>dump</option>-->
        </select>
    </div>
    <div class="form-row cmd-type foundation functional report read write dump bind unbind">
        <label for="node-input-cmdType"><i class="icon-pencil"></i> ieeeAddr</label>
        <input type="text" id="node-input-ieeeAddr">
    </div>
    <div class="form-row cmd-type foundation functional report read write dump bind unbind">
        <label for="node-input-ep"><i class="icon-pencil"></i> endpoint</label>
        <input type="number" id="node-input-ep">
    </div>

    <div class="form-row cmd-type foundation functional read write report bind">
        <label for="node-input-cid"><i class="icon-pencil"></i> cid</label>
        <input type="text" id="node-input-cid">
    </div>
    <div class="form-row cmd-type foundation functional report">
        <label for="node-input-cmd"><i class="icon-pencil"></i> cmd</label>
        <input type="text" id="node-input-cmd">
    </div>
    <div class="form-row cmd-type foundation functional">
        <label for="node-input-zclData"><i class="icon-pencil"></i> zclData</label>
        <input type="text" id="node-input-zclData">
    </div>
    <div class="form-row cmd-type write">
        <label for="node-input-data"><i class="icon-pencil"></i> data</label>
        <input type="text" id="node-input-data">
        <input type="hidden" id="node-input-dataType">
    </div>
    <div class="form-row cmd-type report read write">
        <label for="node-input-attrId"><i class="icon-pencil"></i> attrId</label>
        <input type="text" id="node-input-attrId">
        <input type="hidden" id="node-input-attrIdType">
    </div>
    <div class="form-row cmd-type report">
        <label for="node-input-minInt"><i class="icon-pencil"></i> minInt</label>
        <input type="number" id="node-input-minInt">
    </div>
    <div class="form-row cmd-type report">
        <label for="node-input-maxInt"><i class="icon-pencil"></i> maxInt</label>
        <input type="number" id="node-input-maxInt">
    </div>
    <div class="form-row cmd-type report">
        <label for="node-input-repChange"><i class="icon-pencil"></i> repChange</label>
        <input type="number" id="node-input-repChange">
        <input type="hidden" id="node-input-repChangeType">
    </div>

    <div class="form-row cmd-type bind unbind">
        <label for="node-input-destination"><i class="icon-pencil"></i> destination</label>
        <select id="node-input-destination">
            <option>endpoint</option>
            <option>group</option>
        </select>
    </div>
    <div class="form-row cmd-type bind unbind bind-endpoint">
        <label for="node-input-dstIeeeAddr"><i class="icon-pencil"></i> dst ieeeAddr</label>
        <input type="text" id="node-input-dstIeeeAddr">
    </div>
    <div class="form-row cmd-type bind unbind bind-endpoint">
        <label for="node-input-dstEp"><i class="icon-pencil"></i> dst endpoint</label>
        <input type="number" id="node-input-dstEp">
    </div>
    <div class="form-row cmd-type bind unbind bind-group">
        <label for="node-input-dstGroup"><i class="icon-pencil"></i> dst group</label>
        <input type="number" id="node-input-dstGroup">
    </div>

    <div class="form-row cmd-type foundation functional">
        <label for="node-input-manufSpec"><i class="icon-pencil"></i> manufSpec</label>
        <input type="number" id="node-input-manufSpec">
    </div>
    <div class="form-row cmd-type foundation functional">
        <label for="node-input-disableDefaultRsp"><i class="icon-pencil"></i> disableDefaultRsp</label>
        <input type="number" id="node-input-disableDefaultRsp">
    </div>
    <div class="form-row">
        <label for="execute"><i class=""></i> </label>
        <button id="execute">execute command</button>
    </div>
    <div class="form-row">
        <label for="response"><i class=""></i> response</label>
        <span id="response"></span>
    </div>
</script>

<script type="text/x-red" data-help-name="zigbee-command">
    <b>Execute a command on an endpoint</b>
    <p>See <a href="https://github.com/zigbeer/zigbee-shepherd/wiki#API_foundation" target="_blank">zigbee-shepherd documentation</a></p>
    <p>All properties can be overwritten by incoming msg.</p>
</script>
